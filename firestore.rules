rules_version = '2';

/**
 * Firestore Security Rules for The Golf Society Hub
 * 
 * Collections structure:
 * - societies/{societyId}
 * - societies/{societyId}/members/{memberId}  (member doc ID = auth.uid for security)
 * - societies/{societyId}/events/{eventId}
 * - societies/{societyId}/events/{eventId}/results/{memberId}  (OOM results)
 * - societies/{societyId}/courses/{courseId}
 * - societies/{societyId}/teesets/{teeSetId}
 * - courses/{courseId}  (global courses collection)
 * - teesets/{teeSetId}  (global teesets collection)
 * 
 * Member document fields:
 * - uid: string (Firebase Auth UID, for fallback matching)
 * - name: string
 * - email: string (optional)
 * - roles: string[] (e.g., ["member"], ["captain", "admin"])
 * - handicap: number (optional)
 * - sex: "male" | "female"
 * - status: "active" | "inactive"
 * 
 * IMPORTANT: Member doc IDs should match auth.uid for proper security rule validation.
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================================================
    // HELPER FUNCTIONS
    // ==========================================================================
    
    /**
     * Check if the user is signed in (authenticated)
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    /**
     * Get the current user's UID
     */
    function currentUserUid() {
      return request.auth.uid;
    }
    
    /**
     * Get the member document for the current user in a society
     * Member doc ID should match auth.uid
     */
    function getMemberDoc(societyId) {
      return get(/databases/$(database)/documents/societies/$(societyId)/members/$(currentUserUid()));
    }
    
    /**
     * Check if member document exists for current user
     */
    function memberDocExists(societyId) {
      return exists(/databases/$(database)/documents/societies/$(societyId)/members/$(currentUserUid()));
    }
    
    /**
     * Check if the current user is a member of the society
     * A user is a member if their member document exists and is active
     */
    function isSocietyMember(societyId) {
      return isSignedIn() 
        && memberDocExists(societyId)
        && getMemberDoc(societyId).data.status == "active";
    }
    
    /**
     * Check if the current user has a specific role in the society
     * Roles are stored as a lowercase string array in the member document
     */
    function hasRole(societyId, roleName) {
      return isSocietyMember(societyId)
        && roleName in getMemberDoc(societyId).data.roles;
    }
    
    /**
     * Check if the current user is an admin or captain
     */
    function isAdminOrCaptain(societyId) {
      return hasRole(societyId, "admin") || hasRole(societyId, "captain");
    }
    
    /**
     * Check if the current user is the treasurer
     */
    function isTreasurer(societyId) {
      return hasRole(societyId, "treasurer");
    }
    
    /**
     * Check if the current user is the handicapper
     */
    function isHandicapper(societyId) {
      return hasRole(societyId, "handicapper");
    }
    
    /**
     * Check if the current user can manage members (captain/admin/secretary)
     */
    function canManageMembers(societyId) {
      return hasRole(societyId, "admin") 
        || hasRole(societyId, "captain") 
        || hasRole(societyId, "secretary");
    }
    
    /**
     * Check if the current user can manage events
     */
    function canManageEvents(societyId) {
      return hasRole(societyId, "admin") 
        || hasRole(societyId, "captain")
        || hasRole(societyId, "handicapper");
    }
    
    /**
     * Check if the member document ID matches the current user's UID
     * Used for self-profile updates
     */
    function isSelf(memberId) {
      return isSignedIn() && memberId == currentUserUid();
    }
    
    /**
     * Check if the user is only updating allowed self-profile fields
     * Members can update their own profile fields but NOT roles
     */
    function onlyUpdatingSelfFields() {
      let allowedFields = ['name', 'handicap', 'sex', 'email', 'updatedAt'];
      let changedFields = request.resource.data.diff(resource.data).affectedKeys();
      return changedFields.hasOnly(allowedFields);
    }
    
    /**
     * Validate member data structure for create/update
     */
    function isValidMemberData() {
      let data = request.resource.data;
      return data.name is string
        && data.name.size() >= 2
        && data.roles is list
        && data.status in ["active", "inactive"];
    }
    
    /**
     * Validate event result data
     */
    function isValidResultData() {
      let data = request.resource.data;
      return data.memberId is string
        && data.points is number;
    }
    
    // ==========================================================================
    // SOCIETY RULES
    // ==========================================================================
    
    match /societies/{societyId} {
      // Any authenticated user can read societies they're a member of
      allow read: if isSocietyMember(societyId);
      
      // Only admin/captain can update society settings
      allow update: if isAdminOrCaptain(societyId);
      
      // Treasurer can also update society (for finance-related fields)
      allow update: if isTreasurer(societyId);
      
      // Any authenticated user can create a society (onboarding)
      allow create: if isSignedIn();
      
      // Only admin/captain can delete societies
      allow delete: if isAdminOrCaptain(societyId);
      
      // ========================================================================
      // MEMBERS SUBCOLLECTION
      // ========================================================================
      
      match /members/{memberId} {
        // Members can read all members in their society
        allow read: if isSocietyMember(societyId);
        
        // Self-updates: members can update their own profile (except roles)
        // Their member doc ID must match their auth UID
        allow update: if isSelf(memberId) 
          && onlyUpdatingSelfFields() 
          && isValidMemberData();
        
        // Admin/Captain/Secretary can create, update, delete any member
        allow create: if canManageMembers(societyId) && isValidMemberData();
        allow update: if canManageMembers(societyId) && isValidMemberData();
        allow delete: if canManageMembers(societyId);
        
        // Special case: first member creation during society setup
        // Allow any authenticated user to create themselves as the first member
        // This is needed for society onboarding flow
        allow create: if isSignedIn() 
          && memberId == currentUserUid()
          && isValidMemberData();
      }
      
      // ========================================================================
      // EVENTS SUBCOLLECTION
      // ========================================================================
      
      match /events/{eventId} {
        // Members can read all events in their society
        allow read: if isSocietyMember(societyId);
        
        // Admin/Captain/Handicapper can create, update, delete events
        allow create: if canManageEvents(societyId);
        allow update: if canManageEvents(societyId);
        allow delete: if isAdminOrCaptain(societyId);
        
        // ======================================================================
        // EVENT RESULTS SUBCOLLECTION (OOM points)
        // ======================================================================
        
        match /results/{resultId} {
          // Members can read all results
          allow read: if isSocietyMember(societyId);
          
          // Admin/Captain/Handicapper can manage results
          allow create: if canManageEvents(societyId);
          allow update: if canManageEvents(societyId);
          allow delete: if isAdminOrCaptain(societyId);
        }
      }
      
      // ========================================================================
      // COURSES SUBCOLLECTION (society-level)
      // ========================================================================
      
      match /courses/{courseId} {
        // Members can read all courses
        allow read: if isSocietyMember(societyId);
        
        // Admin/Captain can manage courses
        allow create, update, delete: if isAdminOrCaptain(societyId);
        
        // Tee sets within courses
        match /teeSets/{teeSetId} {
          allow read: if isSocietyMember(societyId);
          allow create, update, delete: if isAdminOrCaptain(societyId);
        }
      }
      
      // ========================================================================
      // TEESETS SUBCOLLECTION (society-level)
      // ========================================================================
      
      match /teesets/{teeSetId} {
        allow read: if isSocietyMember(societyId);
        allow create, update, delete: if isAdminOrCaptain(societyId);
      }
    }
    
    // ==========================================================================
    // GLOBAL COURSES COLLECTION
    // (Some courses may be stored globally with societyId field)
    // ==========================================================================
    
    match /courses/{courseId} {
      // Any authenticated user can read global courses
      // (Access filtering by societyId happens in app code)
      allow read: if isSignedIn();
      
      // Only authenticated users can create courses
      // (App code ensures societyId is set and user has permission)
      allow create: if isSignedIn();
      
      // Update/delete requires being admin/captain of the course's society
      // Since we can't easily verify society membership here, 
      // we rely on app-level permission checks
      allow update, delete: if isSignedIn() 
        && resource.data.societyId != null;
    }
    
    // ==========================================================================
    // GLOBAL TEESETS COLLECTION
    // ==========================================================================
    
    match /teesets/{teeSetId} {
      // Any authenticated user can read global tee sets
      allow read: if isSignedIn();
      
      // Authenticated users can create tee sets
      allow create: if isSignedIn();
      
      // Update/delete requires being authenticated
      // (App-level permission checks enforce role requirements)
      allow update, delete: if isSignedIn();
    }
    
    // ==========================================================================
    // DENY ALL OTHER ACCESS
    // ==========================================================================
    
    // Default deny for any other paths not explicitly matched
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
